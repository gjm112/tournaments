---
title: "rr"
format: html
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

# Round Robin Code

### reference: strength weights

```{r}
num <- 4

# uniform 
qunif(1:num/(num+1), 0, num+1)

# normal
qnorm(((1:num) - 0.5) / num, 0, 1)
```

# Set Up

simulate one match

```{r}
library(tidyverse)

simulate_match <- function(team1, team2, strengths) {
  strength1 <- strengths$True_Strength[strengths$Team == team1]
  strength2 <- strengths$True_Strength[strengths$Team == team2]
  
  prob_team1_wins <- exp(strength1-strength2) / (1 + exp(strength1 - strength2))
  
  winner <- ifelse(runif(1) < prob_team1_wins, team1, team2)
  return(winner)
}
```

round robin tournament function for n rounds

```{r}
simulate_roundrobin_r <- function(num_teams, distribution, ties = TRUE, r = 1, theta_hat = NULL) {
  teams <- paste(1:num_teams)
  n <- length(teams)
  
  # Initialize strength vector
  if (distribution == "Normal") {
    strengths <- qnorm(1:num_teams / (num_teams + 1))
  } else if (distribution == "Same") {
    strengths <- rep(0, num_teams)
  } else if (distribution == "Uniform") {
    strengths <- qunif(1:num_teams / (num_teams + 1), 0, sqrt(12))
  } else if (distribution == "Exponential") {
    strengths <- qexp(1:num_teams / (num_teams + 1), 1)
  } else if (distribution == "Manual") {
    if (is.null(theta_hat)) {
      stop("theta_hat must be provided for Manual distribution")
    }
    strengths <- theta_hat
  } else {
    stop("Distribution not found: Enter Manual to input your own strengths")
  }
  
  # Initialize win/loss counters (indexed by original team position)
  game_wins <- rep(0, num_teams)
  game_losses <- rep(0, num_teams)
  
  # Simulate round robin tournament r times
  for (round in 1:r) {
    for (i in 1:(num_teams - 1)) {
      for (j in (i + 1):num_teams) {
        team1 <- teams[i]
        team2 <- teams[j]
        strength1 <- strengths[i]
        strength2 <- strengths[j]
        
        # Simulate match between team i and team j using their strengths
        match_winner <- simulate_match(team1, team2, strength1, strength2)
        
        # Check which team won based on the returned team name
        if (match_winner == team1) {
          game_wins[i] <- game_wins[i] + 1
          game_losses[j] <- game_losses[j] + 1
        } else {
          game_wins[j] <- game_wins[j] + 1
          game_losses[i] <- game_losses[i] + 1
        }
      }
    }
  }
  
  # Create final dataframe with results
  df <- data.frame(
    team = teams,
    true_strength = strengths,
    game_wins = game_wins,
    game_losses = game_losses,
    distribution = distribution
  )
  
  # Sort by true_strength to assign true rankings
  df <- df %>% 
    arrange(desc(true_strength)) %>% 
    mutate(true_rank = row_number())
  
  # Rank teams based on number of wins
  if (ties == TRUE) {
    df$rank_hat <- rank(-df$game_wins, ties.method = "average")
  } else {
    df$rank_hat <- rank(-df$game_wins, ties.method = "random")
  }
  
  # Select and order columns as specified
  df <- df %>% 
    select(true_rank, true_strength, rank_hat, game_wins, game_losses, distribution) %>%
    arrange(true_rank)
  
  return(df)
}

simulate_roundrobin_r(4,"Normal", r = 1)

df <- list()
for (i in 1:100000){
  df[[i]] <- simulate_roundrobin_r(4, "Same", r=1)
}

test <- do.call(rbind, df)
test$simulation <- rep(c(1:100000), each = 4)

compute_mut_plots(test)
```

## Uniform Distribution of Strengths

run tournament for n rounds

# Saving Output in Different Way

-   have code to simulate one match, round robin tournament for n rounds

-   just need to fix run_tournament function to save output differently?

## Uniform Dist, Save Each Sim

```{r}
run_tournament <- function(num_teams=4, num_rounds=1, dist='uniform'){
  # define teams
  teams <- paste("Team", 1:num_teams)
  
  if (dist == "uniform"){
    stren <- qunif(1:num_teams/(num_teams+1), 0, num_teams+1)
  }
  else if (dist == "normal"){
    stren = qnorm(((1:num_teams) - 0.5) / num_teams, 0, 1)
  }
  
  # put Teams and True_Strength into data frame
  team_strengths <- data.frame(
    Team = teams,
    True_Strength = stren)
  
  # add True_Rank and Seed, order columns
  team_strengths <- team_strengths %>% 
    arrange(-True_Strength) %>% 
    mutate(True_Rank = row_number()) %>% 
    arrange(Team) %>% 
    mutate(Seed = NA) %>% 
    select(Team, True_Rank, True_Strength, Seed)
  
  
  # simulation set up
  n <- 1000
  total_ranks <- data.frame(matrix(NA, nrow = n, ncol = length(teams)))
  colnames(total_ranks) <- teams
  
  kendallcor <- c()
  spearmancor <- c()
  
  ####### new object to save all of the simulations
  simulation_list <- list()
  
  
  # run multiple simulations
  for (i in 1:n) {
    simulation_list[[i]] <- simulate_roundrobin_r(teams, team_strengths, num_rounds) 
    
    
    ranks <- simulation_list[[i]]$Rank_Hat
    team_order <- simulation_list[[i]]$Team
    total_ranks[i, team_order] <- ranks
    
    kendallcor[i] <- cor(simulation_list[[i]]$Rank_Hat, simulation_list[[i]]$True_Rank, method="kendall")
    spearmancor[i] <- cor(simulation_list[[i]]$Rank_Hat, simulation_list[[i]]$True_Rank, method="spearman")
  }
  
  # SUMMARY - Calculate average ranks for each team
  average_ranks <- data.frame(AvgRankHat = colMeans(total_ranks, na.rm = TRUE), Strength = team_strengths$True_Strength, Rank = team_strengths$True_Rank)
  
  # remove NA correlation values
  kendallcor <- na.omit(kendallcor)
  spearmancor <- na.omit(spearmancor)
  
  # kendall and spearman correlations
  k_mean <- mean(kendallcor)
  s_mean <- mean(spearmancor)
  
  results <- list(average_ranks = average_ranks, k_mean = k_mean, s_mean = s_mean, simulation_list = simulation_list, all_k = kendallcor, all_s = spearmancor)
  
  return(results)
}
```

### Run the simulation

```{r}
# run simulation using run_tournament() 
  # inputs are number of teams and number of rounds
results <- run_tournament(8, 1, "uniform")
sims <- results$simulation_list

# results
```

-   run 1000 simulations for different numbers of teams
    -   uniform and normal distributions for strengths
    -   3-8 teams, 16 teams
-   save them as list objects

## Correlation Coefficients Histograms

```{r}
hist(results$all_k, main = "Kendall Cor Dist", xlab = "Kendall Correlation")
hist(results$all_s, main = "Spearman Cor Dist", xlab = "Spearman Correlation")
```
